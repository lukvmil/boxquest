<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.14.1/css/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.14.1/build/ol.js"></script>
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <title>boxquest</title>
</head>

<style>
    .logo {
        font-family: "Open Sans";
        font-weight: 700;
    }
</style>

<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand logo">boxquest</a>
        </div>
    </nav>
    <div class="container p-3">
        <div class="d-grid">
            <!-- <label class="form-label">Box history map</label> -->

            <div class="card border" id="map-container">
                <div id="map" class="map" style="height: 30vh; width: 100%;"></div>
            </div>
            <div class="form-text">Tap a marker above to view the entry for that location</div>

            <button class="btn btn-success btn mt-3" id="add-entry" onclick="location.href='add-entry'+location.search" hidden>Add an Entry</button>
            <!-- <div class="d-flex mt-3">
                <div class="flex-fill">
                    <button class="btn btn-primary" style="width: 100%;">&lt;</button>

                </div>
                <div class="flex-fill">
                    <button class="btn btn-primary" style="width: 100%;">&gt;</button>
                </div>
            </div> -->
            <div class="card border mt-3" id="map-container">
                <!-- <div class="card-header">
                    <ul class="nav nav-pills card-header-pills">
                        <li class="nav-item me-2">
                            <a class="nav-link active" href="#">Prev</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">Next</a>
                        </li>

                    </ul>
                </div> -->
                <div class="card-body">
                    <!-- <h5 class="card-title">Card title</h5> -->
                    <p class="card-text" id="entry-body"></p>
                    <div class="card-text d-flex">
                        <div><small class="text-muted" id="entry-location"></small></div>
                        <div class="ms-auto"><small class="text-muted" id="entry-timestamp"></small></div>
                    </div>
                </div>
                <img class="card-img-bottom" id="entry-img">

            </div>
        </div>
    </div>
</body>

<script>
    const params = new URLSearchParams(window.location.search);
    const addEntryButton = document.getElementById("add-entry");
    const entryBody = document.getElementById("entry-body");
    const entryTimestamp = document.getElementById("entry-timestamp");
    const entryLocation = document.getElementById("entry-location");
    const entryImage = document.getElementById("entry-img");

    let pointSource;
    let lineSource;
    let markerLayer;
    let dotLayer;
    let lineLayer;

    const coords = []
    const entry_list = []

    let map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([-75, 35]),
            maxZoom: 12
        })

    });

    if (params.has("id")) {
        let box_id = params.get("id");
        fetch(`api/box/${box_id}/entries`)
            .then(data => data.json())
            .then(entries => {
                entries.forEach(e => {
                    entry_list.push(e);
                })
                entries.forEach(e => {
                    coords.push(e.location.reverse());
                    entryBody.innerText = e.message;
                    entryTimestamp.innerText = new Date(e.timestamp).toLocaleString();
                    entryLocation.innerText = e.location_str;
                    entryImage.setAttribute("src", `api/img/${e.image}`);
                });
                loadLines();
                loadPoints();
            });
    }


    const markerStyle = new ol.style.Style({
        image: new ol.style.Circle({
            radius: 10,
            fill: new ol.style.Fill({
                color: '#fff',
            }),
            stroke: new ol.style.Stroke({
                color: '#212529',
                width: 4,
            }),
        }),
    });

    const dotStyle = new ol.style.Style({
        image: new ol.style.Circle({
            radius: 4,
            fill: new ol.style.Fill({
                color: '#000',
            })
        })
    });

    const lineStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: "#212529",
            width: 4
        })
    });

    const lineFeatures = [];
    const pointFeatures = [];

    function loadPoints() {
        let count = 0;
        coords.forEach(c => {
            pointFeatures.push(
                new ol.Feature({
                    geometry: new ol.geom.Point(
                        ol.proj.fromLonLat(c)
                    ),
                    name: count
                })
            );
            count += 1;
        });
        pointSource = new ol.source.Vector({ features: pointFeatures });
        map.getView().fit(pointSource.getExtent(), {padding: [100, 100, 100, 100], maxZoom: 10});
        markerLayer = new ol.layer.Vector({
            source: pointSource,
            style: markerStyle
        });

        dotLayer = new ol.layer.Vector({
            source: pointSource,
            style: dotStyle
        });
        map.addLayer(markerLayer);
        // map.addLayer(dotLayer);
        let select = new ol.interaction.Select({
            condition: ol.events.condition.click,
            layers: [markerLayer],
            style: dotStyle
        });

        map.addInteraction(select);

        select.on('select', e => {
            let features = e.target.getFeatures().getArray()
            if (features.length) {
                let name = features[0].get('name')
                console.log(name);
                setActiveEntry(name);
            }
        });
    }

    function setActiveEntry(id) {
        e = entry_list[id];
        entryBody.innerText = e.message;
        entryTimestamp.innerText = new Date(e.timestamp).toLocaleString();
        entryImage.setAttribute("src", `api/img/${e.image}`);
    }

    
    function loadLines() {
        for (let i = 0; i < coords.length - 1; i++) {
            lineFeatures.push(
                new ol.Feature({
                    geometry: new ol.geom.LineString([
                        ol.proj.fromLonLat(coords[i]),
                        ol.proj.fromLonLat(coords[i + 1])
                    ]),
                })
            );
        }
        lineSource = new ol.source.Vector({ features: lineFeatures });
        lineLayer = new ol.layer.Vector({
            source: lineSource,
            style: lineStyle
        });
        map.addLayer(lineLayer);
    }

    if (params.has("key")) {
        let box_key = params.get("key");
        sessionStorage.setItem("box_key", box_key);
        fetch(`api/get_id?key=${box_key}`)
            .then(data => data.json())
            .then(data => {
                window.location.href = `${window.location.pathname}?id=${data.pub_id}`;
            })
    }

    if (sessionStorage.getItem("box_key")) {
        addEntryButton.removeAttribute("hidden");
    }

</script>

</html>